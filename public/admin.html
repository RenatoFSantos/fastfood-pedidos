<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Pedidos - Alhadas Burger</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: url('images/fastfood_pattern.jpg') repeat; /* Assumindo nome da imagem como fast_food_pattern.png; ajuste se necess√°rio */
            background-color: #fff;
            color: #333;
            position: relative;
            overflow: hidden;
        }

        .container {
            display: flex; 
            justify-content: space-around; 
            gap: 20px;
            margin: 10px;
        }

        .title {
            display: flex; 
            justify-content: center; 
            align-items: center;
            background: rgba(255,255,255,0.96); 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            margin-bottom: 15px;
            padding: 20px;
            font-size: 2.0em;
            font-weight: bold;
        }

        .columns {
            display: flex;
            min-width: 90vw;
            justify-content: space-between;
            gap: 20px;
        }

        .column { width: 30%; background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .column h2 { text-align: center; margin-bottom: 15px; color: #333; }
        .column ul { list-style: none; padding: 0; min-height: 200px; }
        .column li { 
            background: #eee; margin-bottom: 10px; padding: 12px; border-radius: 5px; 
            text-align: center; font-weight: bold; font-size: 3.1em;
        }        

        .column-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .pedido-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .pedido-item {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
        }

        .pedido-item span {
            margin: 0 20px;
        }

        .arrow {
            font-size: 24px;
            cursor: pointer;
            user-select: none;
        }

        .arrow.disabled {
            color: #ccc;
            cursor: default;
        }

        .itens-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-height: 300px;
            overflow-y: auto;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }

        .itens-container h3 {
            margin-top: 0;
            font-size: 16px;
        }

        .itens-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .item {
            margin-bottom: 10px;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="title">Lista de Pedidos - Alhadas Burger</div>
    <div class="container">
        <div class="columns">
            <div class="column" id="aguardando">
                <h2>AGUARDANDO PREPARO</h2>
                <ul class="pedido-list"></ul>
            </div>
            <div class="column" id="em-preparo">
                <h2>EM PREPARO</h2>
                <ul class="pedido-list"></ul>
            </div>
            <div class="column" id="concluido">
                <h2>CONCLU√çDO</h2>
                <ul class="pedido-list"></ul>
            </div>
        </div>
    </div>
    <div class="itens-container" id="itens-container">
        <h3>Itens do Pedido <span id="pedido-id"></span></h3>
        <ul class="itens-list" id="itens-list"></ul>
    </div>

    <script>
        const STATUS_MAP = {
            'AGUARDANDO PREPARO': 0,
            'EM PREPARO': 1,
            'CONCLUIDO': 2
        };
        const STATUS_ARRAY = ['AGUARDANDO PREPARO', 'EM PREPARO', 'CONCLUIDO'];
        const API_BASE = '/api'; // Ajuste se o servidor estiver em outro host/porta
        const AUTH_USER = 'admin';
        const AUTH_PASS = 'fastfood2026';
        const AUTH_HEADER = 'Basic ' + btoa(AUTH_USER + ':' + AUTH_PASS);

        let lastPedidoId = localStorage.getItem('lastPedidoId');

        async function fetchPedidos() {
            try {
                const response = await fetch(`${API_BASE}/pedidos`);
                if (!response.ok) throw new Error('Erro ao buscar pedidos');
                const pedidos = await response.json();
                renderPedidos(pedidos);
                if (lastPedidoId) {
                    fetchItens(lastPedidoId);
                }
            } catch (err) {
                console.error(err);
            }
        }

        function renderPedidos(pedidos) {
            const columns = {
                aguardando: document.querySelector('#aguardando .pedido-list'),
                'em-preparo': document.querySelector('#em-preparo .pedido-list'),
                concluido: document.querySelector('#concluido .pedido-list')
            };
            Object.values(columns).forEach(ul => ul.innerHTML = '');

            pedidos.forEach(pedido => {
                const li = document.createElement('li');
                li.className = 'pedido-item';
                li.innerHTML = `
                    <span class="arrow ${STATUS_MAP[pedido.status] === 0 ? 'disabled' : ''}" data-direction="left">&lt;</span>
                    <span class="pedido-id" data-id="${pedido.id}">${pedido.id}</span>
                    <span class="arrow ${STATUS_MAP[pedido.status] === 2 ? 'disabled' : ''}" data-direction="right">&gt;</span>
                `;
                const targetColumn = pedido.status === 'AGUARDANDO PREPARO' ? 'aguardando' :
                                     pedido.status === 'EM PREPARO' ? 'em-preparo' : 'concluido';
                columns[targetColumn].appendChild(li);

                li.querySelector('.pedido-id').addEventListener('click', () => {
                    lastPedidoId = pedido.id;
                    localStorage.setItem('lastPedidoId', lastPedidoId);
                    fetchItens(pedido.id);
                });

                li.querySelectorAll('.arrow:not(.disabled)').forEach(arrow => {
                    arrow.addEventListener('click', () => movePedido(pedido.id, pedido.status, arrow.dataset.direction));
                });
            });
        }

        async function fetchItens(pedidoId) {
            try {
                const response = await fetch(`${API_BASE}/pedidos/${pedidoId}/itens`, {
                    headers: { 'Authorization': AUTH_HEADER }
                });
                if (!response.ok) throw new Error('Erro ao buscar itens');
                const itens = await response.json();
                renderItens(pedidoId, itens);
            } catch (err) {
                console.error(err);
            }
        }

        function renderItens(pedidoId, itens) {
            const container = document.getElementById('itens-container');
            const idSpan = document.getElementById('pedido-id');
            const list = document.getElementById('itens-list');
            idSpan.textContent = pedidoId;
            list.innerHTML = '';
            itens.forEach(item => {
                const li = document.createElement('li');
                li.className = 'item';
                li.textContent = `üì¶ - ${item.quantidade}.toFixed()x ${item.produto}`;
                list.appendChild(li);
            });
            container.style.display = 'block';
        }

        async function movePedido(id, currentStatus, direction) {
            const currentIndex = STATUS_MAP[currentStatus];
            const newIndex = direction === 'left' ? currentIndex - 1 : currentIndex + 1;
            if (newIndex < 0 || newIndex > 2) return;
            const novoStatus = STATUS_ARRAY[newIndex];

            try {
                const response = await fetch(`${API_BASE}/update-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': AUTH_HEADER
                    },
                    body: JSON.stringify({ id, novoStatus })
                });
                if (!response.ok) throw new Error('Erro ao atualizar status');
                fetchPedidos(); // Atualiza a lista imediatamente
            } catch (err) {
                console.error(err);
            }
        }

        // Inicializa
        fetchPedidos();
        setInterval(fetchPedidos, 10000);
    </script>
</body>
</html>